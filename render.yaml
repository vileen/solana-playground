services:
  - type: web
    name: solana-snapshot-tool
    env: node
    buildCommand: |
      yarn install
      # List files in current directory for debugging
      echo "Current directory content:"
      ls -la
      
      # Compile frontend first
      npx tsc --skipLibCheck
      npx vite build
      
      # Create dist/backend directory
      mkdir -p dist/backend
      
      # Run bootstrap script to ensure backend files are compiled
      echo "Running bootstrap script to compile backend files..."
      node bootstrap.js
      
      # Explicitly compile the backend files as a fallback
      echo "Compiling backend files with tsc..."
      npx tsc --project tsconfig.json --outDir dist/backend --skipLibCheck
      
      # Check the src/backend folder
      echo "Source backend files:"
      ls -la src/backend
      
      # Check if compiled backend files exist
      echo "Compiled files in dist/backend:"
      ls -la dist/backend || echo "Backend directory is empty!"
      
      # Make the startup script executable
      chmod +x startup.sh
    startCommand: ./startup.sh
    envVars:
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: 16
      - key: YARN_VERSION
        value: 1.22.19
      - key: PORT
        value: 10000
      - key: SOLANA_RPC_URL
        sync: false
      - key: SOLANA_API_KEY
        sync: false
      # Add Vite prefixed versions for the frontend
      - key: VITE_SOLANA_RPC_URL
        fromKey: SOLANA_RPC_URL
      - key: VITE_SOLANA_API_KEY
        fromKey: SOLANA_API_KEY
    disk:
      name: data
      mountPath: /data
      sizeGB: 1 